<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy SPL Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-800 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-900 p-8 rounded-lg shadow-lg max-w-md w-full">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Fantasy SPL Analyzer</h1>

        <div class="mb-6">
            <label for="managerIdInput" class="block text-gray-300 text-sm font-bold mb-2">
                Enter your Fantasy SPL Manager ID to analyze your performance.
            </label>
            <input type="text" id="managerIdInput" placeholder="e.g., 12345"
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 focus:border-blue-500">
        </div>

        <button id="analyzeButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full focus:outline-none focus:shadow-outline transition duration-200">
            Analyze My Performance
        </button>

        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">Your Analysis Outcomes:</h2>

            <div class="bg-gray-800 p-4 rounded-lg mb-4">
                <p class="text-gray-400 text-sm">Overall Rank:</p>
                <p id="overallRankDisplay" class="text-xl font-bold text-green-400">...</p>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg mb-4">
                <p class="text-gray-400 text-sm">Most Captained Player:</p>
                <p id="mostCaptainNameDisplay" class="text-xl font-bold text-green-400">...</p>

                <p class="text-gray-400 text-sm mt-2">You Captained him:</p>
                <p id="timesCaptainedDisplay" class="text-xl font-bold text-green-400">...</p>

                <p class="text-gray-400 text-sm mt-2">He Earned You:</p>
                <p id="captainedPointsDisplay" class="text-xl font-bold text-green-400">...</p>
            </div>
            <div id="errorMessageDisplay" class="hidden bg-red-800 p-3 rounded text-red-100 text-center">
                </div>
        </div>
    </div>

    <script>
        document.getElementById('analyzeButton').addEventListener('click', analyzePerformance);

        async function analyzePerformance() {
            const managerId = document.getElementById('managerIdInput').value;
            const overallRankDisplay = document.getElementById('overallRankDisplay');
            const mostCaptainNameDisplay = document.getElementById('mostCaptainNameDisplay'); // New
            const timesCaptainedDisplay = document.getElementById('timesCaptainedDisplay');   // New
            const captainedPointsDisplay = document.getElementById('captainedPointsDisplay'); // New
            const errorMessageDisplay = document.getElementById('errorMessageDisplay');

            // --- Visual feedback for loading state ---
            overallRankDisplay.textContent = 'Loading...';
            mostCaptainNameDisplay.textContent = 'Loading...';
            timesCaptainedDisplay.textContent = 'Loading...';
            captainedPointsDisplay.textContent = 'Loading...';
            errorMessageDisplay.classList.add('hidden'); // Hide any previous errors
            errorMessageDisplay.textContent = ''; // Clear previous error text

            if (!managerId) {
                overallRankDisplay.textContent = 'N/A';
                mostCaptainNameDisplay.textContent = 'N/A';
                timesCaptainedDisplay.textContent = 'N/A';
                captainedPointsDisplay.textContent = 'N/A';
                errorMessageDisplay.textContent = 'Please enter a Manager ID.';
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            try {
                // Call your Netlify function
                const response = await fetch(`/.netlify/functions/fetch-spl-data?id=${managerId}`); // Removed type=history as it's not strictly needed here
                const data = await response.json();

                if (response.ok) {
                    overallRankDisplay.textContent = data.overallRank || 'Not found';
                    mostCaptainNameDisplay.textContent = data.mostCaptainName || 'Not found';
                    timesCaptainedDisplay.textContent = data.timesCaptained !== undefined ? data.timesCaptained : 'N/A';
                    captainedPointsDisplay.textContent = data.totalCaptainedPoints !== undefined ? data.totalCaptainedPoints : 'N/A';
                } else {
                    // Handle errors from the Netlify function
                    overallRankDisplay.textContent = 'Error';
                    mostCaptainNameDisplay.textContent = 'Error';
                    timesCaptainedDisplay.textContent = 'Error';
                    captainedPointsDisplay.textContent = 'Error';
                    errorMessageDisplay.textContent = data.error || 'An unknown error occurred.';
                    errorMessageDisplay.classList.remove('hidden');
                }
            } catch (error) {
                // Handle network errors or issues before the function response
                overallRankDisplay.textContent = 'Error';
                mostCaptainNameDisplay.textContent = 'Error';
                timesCaptainedDisplay.textContent = 'Error';
                captainedPointsDisplay.textContent = 'Error';
                errorMessageDisplay.textContent = `Failed to connect to analysis service: ${error.message}.`;
                errorMessageDisplay.classList.remove('hidden');
                console.error('Frontend fetch error:', error);
            }
        }
    </script>
</body>
</html>